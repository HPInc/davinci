"use strict";(self.webpackChunk_davinci_docs=self.webpackChunk_davinci_docs||[]).push([[821],{3905:(e,t,n)=>{n.d(t,{Zo:()=>p,kt:()=>v});var a=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var s=a.createContext({}),c=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},p=function(e){var t=c(e.components);return a.createElement(s.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},d=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,o=e.originalType,s=e.parentName,p=l(e,["components","mdxType","originalType","parentName"]),d=c(n),v=r,m=d["".concat(s,".").concat(v)]||d[v]||u[v]||o;return n?a.createElement(m,i(i({ref:t},p),{},{components:n})):a.createElement(m,i({ref:t},p))}));function v(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=n.length,i=new Array(o);i[0]=d;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:r,i[1]=l;for(var c=2;c<o;c++)i[c]=n[c];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}d.displayName="MDXCreateElement"},883:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>i,default:()=>u,frontMatter:()=>o,metadata:()=>l,toc:()=>c});var a=n(7462),r=(n(7294),n(3905));const o={},i="Validation",l={unversionedId:"modules/http-server/validation",id:"version-2.x/modules/http-server/validation",title:"Validation",description:"The HttpServer module includes support for validating requests.",source:"@site/versioned_docs/version-2.x/modules/http-server/validation.md",sourceDirName:"modules/http-server",slug:"/modules/http-server/validation",permalink:"/davinci/docs/2.x/modules/http-server/validation",draft:!1,tags:[],version:"2.x",frontMatter:{},sidebar:"mySidebar",previous:{title:"Context",permalink:"/davinci/docs/2.x/modules/http-server/context"},next:{title:"OpenAPI",permalink:"/davinci/docs/2.x/modules/openapi/"}},s={},c=[{value:"Enabling Validation",id:"enabling-validation",level:2},{value:"Ajv Validation",id:"ajv-validation",level:2},{value:"Customising Ajv Validation",id:"customising-ajv-validation",level:3},{value:"Customise Options",id:"customise-options",level:4},{value:"Customise Plugins",id:"customise-plugins",level:4}],p={toc:c};function u(e){let{components:t,...n}=e;return(0,r.kt)("wrapper",(0,a.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"validation"},"Validation"),(0,r.kt)("p",null,"The HttpServer module includes support for validating requests. "),(0,r.kt)("h2",{id:"enabling-validation"},"Enabling Validation"),(0,r.kt)("p",null,"The validation logic is framework-agnostic and can be performed using any validation library of choice.\nTo enable validation, you just have to pass a ",(0,r.kt)("inlineCode",{parentName:"p"},"validationFactory")," to the HttpServer options like this:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},"new ExpressHttpServer({\n    contextFactory,\n    validationFactory: (route: Route<Request>) => {\n        // perform your validator initialization logic, if necessary\n        \n        // then return the validation function\n        return data => {\n            // if data is not valid, throw an error\n            throw new httpErrors.BadRequest('Invalid data')\n            \n            // if data is valid, return it\n            return data\n        }\n    }\n})\n")),(0,r.kt)("h2",{id:"ajv-validation"},"Ajv Validation"),(0,r.kt)("p",null,"For convenience, DaVinci ships with a validator based on Ajv, that can be used as such:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},"new ExpressHttpServer({\n    contextFactory,\n    validationFactory: createAjvValidator({\n        ajvOptions: {\n            header: { coerceTypes: true },\n            query: { coerceTypes: true }\n        },\n        plugins: [[addErrors as any]]\n    })\n})\n")),(0,r.kt)("h3",{id:"customising-ajv-validation"},"Customising Ajv Validation"),(0,r.kt)("p",null,"You have the possibility to use a default validator by calling ",(0,r.kt)("inlineCode",{parentName:"p"},"createAjvValidator()")," empty."),(0,r.kt)("p",null,"Otherwise, you can fully customize each instance of the ",(0,r.kt)("inlineCode",{parentName:"p"},"AjvValidator"),", which has one instance of Ajv for each of the following request elements: header, query, body, path."),(0,r.kt)("h4",{id:"customise-options"},"Customise Options"),(0,r.kt)("p",null,"You can pass an Ajv Options object like the following to apply the same options to all the Ajv instances:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},"new FastifyHttpServer({\n    contextFactory,\n    validationFactory: createAjvValidator({\n        ajvOptions: { strict: true, coerceTypes: false }\n    })\n})\n")),(0,r.kt)("p",null,"Or you can specify the Ajv Options individually for each of the sources: "),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},"new ExpressHttpServer({\n    contextFactory,\n    validationFactory: createAjvValidator({\n        ajvOptions: {\n            header: { coerceTypes: true },\n            query: { coerceTypes: true }\n        }\n    })\n})\n")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Note")," that in this case, if you don't pass specific options for a given source, the default options will be used for that source's instance."),(0,r.kt)("h4",{id:"customise-plugins"},"Customise Plugins"),(0,r.kt)("p",null,"Similarly to the Ajv Options, Ajv Plugins can be also added to all or to some of the sources."),(0,r.kt)("p",null,"The following example will apply the plugin with the given options to the Ajv instances for all the sources:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},"new FastifyHttpServer({\n    contextFactory,\n    validationFactory: createAjvValidator({\n        // Array of tuples where the first element of the tuple is the plugin\n        // and the second is the options for the plugin (if needed)\n        plugins: [[addErrors, { singleError: true }]]\n    })\n})\n")),(0,r.kt)("p",null,"Or you can apply the plugins only to some instances:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},"new FastifyHttpServer({\n    contextFactory,\n    validationFactory: createAjvValidator({\n        plugins: {\n            body: [[somePlugin]],\n            query: [[somePlugin], [someOtherPlugin]]\n        }\n    })\n})\n")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Note")," that ",(0,r.kt)("inlineCode",{parentName:"p"},"addFormats")," Ajv plugin is always added by default to all the Ajv instances. trying to add this plugin again will cause an error."))}u.isMDXComponent=!0}}]);